#!/bin/bash

echo

if [[ ! -d /usr/lib/modules/$(uname -r) ]]; then
  gum confirm "Linux kernel has been updated. Reboot?" && barchti-system-reboot
elif [[ -f $HOME/.local/state/barchti/reboot-required ]]; then
  gum confirm "Updates require reboot. Ready?" && barchti-system-reboot
fi

running_hyprland=$(readlink /proc/$(pgrep -x Hyprland)/exe 2>/dev/null)
if [[ $running_hyprland == *"(deleted)"* ]]; then
  gum confirm "Hyprland has been updated. Reboot?" && barchti-system-reboot
fi

for file in "$HOME"/.local/state/barchti/restart-*-required; do
  if [[ -f $file ]]; then
    filename=$(basename "$file")
    service=$(echo "$filename" | sed 's/restart-\(.*\)-required/\1/')
    echo "Restarting $service"
    barchti-state clear "$filename"
    barchti-restart-"$service"
  fi
done
